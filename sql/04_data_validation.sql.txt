-- ============================================================
-- STEP 4: DATA VALIDATION & TYPE CORRECTION
-- Purpose:
-- Validate analytical columns in incident_fact
-- Detect hidden data quality issues before KPI computation
-- Fix incorrect data types permanently
-- ============================================================


-- ============================================================
-- 4.1 Validate table row count
-- Ensures data loaded correctly from raw → fact
-- ============================================================

SELECT COUNT(*) AS total_incidents
FROM public.incident_fact;


-- ============================================================
-- 4.2 Validate Resolution Time data type
-- Resolution time is critical for MTTR & SLA metrics
-- ============================================================

SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_name = 'incident_fact'
  AND column_name = 'resolution_time_hours';


-- ============================================================
-- 4.3 Check for negative resolution times
-- Negative values indicate incorrect timestamps or logic
-- ============================================================

SELECT COUNT(*) AS negative_resolution_time
FROM public.incident_fact
WHERE resolution_time_hours::numeric < 0;


-- ============================================================
-- 4.4 Permanently fix resolution_time_hours data type
-- CSV imports often load numeric columns as TEXT
-- ============================================================

ALTER TABLE public.incident_fact
ALTER COLUMN resolution_time_hours
TYPE NUMERIC
USING resolution_time_hours::numeric;


-- ============================================================
-- 4.5 Validate SLA breach flag data type
-- This column must be numeric for KPI calculations
-- ============================================================

SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_name = 'incident_fact'
  AND column_name = 'sla_breach_flag';


-- ============================================================
-- 4.6 Inspect SLA breach flag values
-- Ensures only valid binary values exist
-- ============================================================

SELECT DISTINCT sla_breach_flag
FROM public.incident_fact;


-- ============================================================
-- 4.7 Permanently convert SLA breach flag to INTEGER
-- Fixes TEXT → INTEGER mismatch
-- ============================================================

ALTER TABLE public.incident_fact
ALTER COLUMN sla_breach_flag
TYPE INTEGER
USING sla_breach_flag::INTEGER;


-- ============================================================
-- 4.8 Enforce SLA breach flag integrity
-- Prevents invalid future inserts
-- ============================================================

ALTER TABLE public.incident_fact
ADD CONSTRAINT chk_sla_breach_flag
CHECK (sla_breach_flag IN (0, 1));


-- ============================================================
-- 4.9 Validate priority column type
-- Priority must be numeric for SLA rules
-- ============================================================

SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_name = 'incident_fact'
  AND column_name = 'priority';


-- ============================================================
-- 4.10 Check priority value range
-- ============================================================

SELECT DISTINCT priority
FROM public.incident_fact
ORDER BY priority;


-- ============================================================
-- 4.11 Validate final_resolved_at completeness
-- Ensures no NULL values for closed / resolved incidents
-- ============================================================

SELECT COUNT(*) AS null_final_resolved_at
FROM public.incident_fact
WHERE final_resolved_at IS NULL;


-- ============================================================
-- 4.12 Validate active flag logic
-- Active tickets should not be marked as resolved
-- ============================================================

SELECT COUNT(*) AS invalid_active_records
FROM public.incident_fact
WHERE is_active = 1
  AND incident_state IN ('Resolved');


-- ============================================================
-- STEP 4 COMPLETE
-- Dataset is now validated, typed correctly,
-- and safe for KPI computation
-- ============================================================
